---
id: javascript-this-8
title: 従来の関数 vs アロー関数
level: 3
---

### 従来の関数 vs アロー関数

`setTimeout` などのコールバック内でメソッドを使いたい場面を比較してみましょう。

```js:arrow-vs-function.js
class Timer {
    constructor() {
        this.seconds = 0;
    }

    // 従来の方法: 失敗例
    startLegacy() {
        setTimeout(function() {
            // ここでの this はグローバルまたはundefined（setTimeoutの仕様）
            // そのため this.seconds にアクセスできずNaNなどになる
            try {
                this.seconds++; 
                console.log("Legacy:", this.seconds);
            } catch (e) {
                console.log("Legacy: Error -", e.message);
            }
        }, 100);
    }

    // アロー関数: 成功例
    startModern() {
        setTimeout(() => {
            // アロー関数は定義時のスコープ（startModern内のthis = インスタンス）を捕獲する
            this.seconds++;
            console.log("Modern:", this.seconds);
        }, 100);
    }
}

const timer = new Timer();
timer.startLegacy();
timer.startModern();
```

```js-exec:arrow-vs-function.js
Legacy: Error - Cannot read properties of undefined (reading 'seconds')
Modern: 1
```

> **注意:** アロー関数は便利な反面、`this` を動的に変更することができません（`call` や `bind` を使っても無視されます）。そのため、動的なコンテキストが必要な場合（例：オブジェクトのメソッド定義そのものや、ライブラリ等で `this` を注入される場合）には通常の関数式を使います。

# この章のまとめ

JavaScriptの `this` は、他の静的な言語とは異なり「呼び出し時」に解決されます。

1.  **メソッド呼び出し (`obj.method()`)**: `this` は `obj`。
2.  **関数呼び出し (`func()`)**: `this` は `undefined` (Strict Mode) またはグローバルオブジェクト。
3.  **明示的な指定**: `call`, `apply` で一時的に、`bind` で永続的に `this` を指定可能。
4.  **アロー関数**: 独自の `this` を持たず、外側のスコープの `this` をそのまま使う（レキシカルスコープ）。

次の章では、この `this` を活用してオブジェクト指向プログラミングの核心である「オブジェクトとプロトタイプ」について学びます。

# 練習問題1: 失われたコンテキストの修復

以下のコードは、ボタンクリック時（ここではシミュレーション）にユーザー名を表示しようとしていますが、エラーになります。

1.  `bind` を使って修正してください。
2.  `greet` メソッド自体をアロー関数に変更するアプローチではなく、呼び出し側を修正する形で解答してください。

```js:practice5_1.js
const user = {
    name: "Tanaka",
    greet: function() {
        console.log(`Hello, ${this.name}`);
    }
};

// クリックイベントのシミュレーター（変更不可）
function simulateClick(callback) {
    // 内部で単なる関数呼び出しとして実行される
    callback(); 
}

// --- 以下を修正してください ---
simulateClick(user.greet); 
```

```js-exec:practice5_1.js
```
